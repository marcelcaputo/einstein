<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Consolidado de Dados</title>
    <!-- Carrega o Tailwind CSS via CDN para os estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body {
                background-color: #fff;
                font-size: 10pt;
            }
            .no-print {
                display: none;
            }
            .print-area {
                width: 100%;
                margin: 0;
                padding: 0;
            }
            /* Garantir que as tabelas ocupem 100% no print */
            .data-card table {
                table-layout: fixed;
            }
        }

        .data-card {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .header-title {
            color: #004f92;
        }
        
        .page-report-separator {
            margin-top: 2.5rem;
            margin-bottom: 2.5rem;
            border-top: 3px dashed #cbd5e1; /* Cor cinza suave para o separador */
            padding-top: 2.5rem;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans print-area">

    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        <header class="mb-8 pb-4 border-b border-gray-300 no-print">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold header-title">Relatório de Dados</h1>
                <div class="flex space-x-3">
                    <button id="print-button" onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors shadow-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm0 4h10v7H5V8zm2-4h6v3H7V4z" clip-rule="evenodd" />
                        </svg>
                        Imprimir / Gerar PDF
                    </button>
                </div>
            </div>
            
            <p class="text-gray-500 mt-2">Status: <span id="report-type" class="font-medium"></span></p>
            <p class="text-xs text-gray-500 mt-1">Gerado em: <span id="generation-date"></span></p>
            
            <div class="mt-4">
                <a id="toggle-report-mode" href="#" class="text-sm text-blue-600 hover:text-blue-800 underline font-medium"></a>
            </div>
            <!-- Elemento Opcional: Só existe no modo Single, usado na correção -->
            <p id="report-page-id" class="text-xs text-gray-500 mt-1"></p> 
        </header>

        <div id="report-content">
            <!-- Conteúdo do relatório será injetado aqui -->
            <p class="text-center text-gray-500 mt-10">Carregando dados...</p>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIGURAÇÕES E CHAVES DE ARMAZENAMENTO (Espelho do index.html e editor.html)
        // =================================================================

        const DATE_STORAGE_KEY_BASE = 'lastUpdateDate';
        
        // Definições de páginas (copiadas do editor.html)
        const PAGE_DEFINITIONS = [
            { id: 'index.html', name: 'KPI Geral (Dashboard Principal)' },
            { id: 'kpi-mes.html', name: 'KPI Mês' },
            { id: 'videos.html', name: 'Vídeos' },
            { id: 'flashcards.html', name: 'Flashcards' },
            { id: 'questoes.html', name: 'Questões' },
            { id: 'mapas.html', name: 'Mapas + Apostila' },
            { id: 'cadastros.html', name: 'Cadastros' },
            { id: 'kpi-av.html', name: 'KPI AV' },
            { id: 'status-av.html', name: 'Status AV' },
            { id: 'calendario.html', name: 'Calendário' },
        ];


        const initialKpiData = [
            { id: 1, title: 'Material para Gravação', current: 102, total: 600, percentage: 17, specialty: "Cardiologia", subspecialty: "Clínica Geral", module: "Módulo A" },
            // ... (Apenas para fallback, o loadData usará o localStorage real)
        ];

        const initialChartData = {
            monthlyLimits: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dec'],
                values: [40, 70, 90, 50, 100, 60, 30, 80, 55, 75, 45, 65],
                limit: 75
            },
            detailedProgress: {
                titleCard1: 'Métricas de Produção',
                productionMetrics: [], 
                reviewMetrics: []
            }
        };

        // --- Funções Auxiliares de URL e Storage ---

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function getCurrentFormattedDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return `${date} às ${time}`;
        }
        
        // Define o Page ID padrão para 'index.html' se não for especificado
        const URL_PAGE_ID = getUrlParameter('page');
        const URL_MODE = getUrlParameter('mode');

        
        /**
         * Carrega e normaliza os dados para uma dada pageId.
         * Retorna um objeto com kpiData e chartData, ou null se não houver dados.
         */
        function loadData(pageId) {
            const STORAGE_KEY_KPI = `kpi_${pageId}`;
            const CHART_STORAGE_KEY_CHART = `chart_${pageId}`;

            // Tenta carregar KPIs
            const storedKpi = localStorage.getItem(STORAGE_KEY_KPI);
            const kpiData = storedKpi ? JSON.parse(storedKpi) : null;
            
            // Tenta carregar Charts
            const storedChart = localStorage.getItem(CHART_STORAGE_KEY_CHART);
            let chartData = storedChart ? JSON.parse(storedChart) : null;

            if (!kpiData && !chartData) {
                return null; // Não há dados para esta página
            }

            // Normalização e Fallbacks para ChartData (essencial para compatibilidade)
            if (chartData) {
                if (!chartData.detailedProgress) chartData.detailedProgress = initialChartData.detailedProgress;
                
                const detailed = chartData.detailedProgress;

                if (!detailed.productionMetrics) detailed.productionMetrics = initialChartData.detailedProgress.productionMetrics;
                if (!detailed.reviewMetrics) {
                    // Conversão de estrutura antiga (novoValor/atualizacaoValor)
                    if (detailed.novoValor !== undefined && detailed.atualizacaoValor !== undefined) {
                        detailed.reviewMetrics = [
                            { label: 'Novo', value: detailed.novoValor, color: '#38A169' },
                            { label: 'Atualização', value: detailed.atualizacaoValor, color: '#FCD34D' }
                        ];
                    } else {
                        detailed.reviewMetrics = initialChartData.detailedProgress.reviewMetrics;
                    }
                }
                // Fallbacks simples para títulos
                if (detailed.titleCard1 === undefined) detailed.titleCard1 = initialChartData.detailedProgress.titleCard1;
                if (detailed.titleCard2 === undefined) detailed.titleCard2 = initialChartData.detailedProgress.titleCard2;
            } else {
                chartData = JSON.parse(JSON.stringify(initialChartData)); // Usa fallback se só houver KPI
            }


            return { 
                kpiData: kpiData || [], 
                chartData: chartData 
            };
        }


        // =================================================================
        // FUNÇÕES DE GERAÇÃO DE HTML (Copias simplificadas do index.html)
        // =================================================================

        function generateKpiTable(kpiData) {
            let html = `
                <div class="data-card">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Cartões KPI</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Título</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Progresso</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Especialidade</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Módulo</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;
            if (kpiData.length === 0) {
                html += `<tr><td colspan="4" class="px-4 py-4 text-center text-sm text-gray-500">Nenhum KPI cadastrado.</td></tr>`;
            } else {
                kpiData.forEach(kpi => {
                    const percentage = ((kpi.current / kpi.total) * 100).toFixed(0);
                    html += `
                        <tr>
                            <td class="px-4 py-2 text-sm font-medium text-gray-900">${kpi.title}</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${kpi.current} / ${kpi.total} (${percentage}%)</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${kpi.specialty}</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${kpi.module}</td>
                        </tr>
                    `;
                });
            }
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return html;
        }

        function generateDetailedProgress(chartData) {
            const detailed = chartData.detailedProgress;
            const productionMetrics = detailed.productionMetrics || [];
            const reviewMetrics = detailed.reviewMetrics || [];
            
            const totalProduction = productionMetrics.reduce((sum, m) => sum + m.value, 0); 
            const totalReview = reviewMetrics.reduce((sum, m) => sum + m.value, 0);

            let html = `
                <div class="data-card">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Métricas Detalhadas</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Card 1: Produção -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">${detailed.titleCard1 || 'Métricas de Produção'} (Total: ${totalProduction})</h4>
                            <table class="min-w-full divide-y divide-gray-100">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Métrica</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productionMetrics.map(m => `
                                        <tr>
                                            <td class="px-3 py-2 text-sm text-gray-700">${m.label}</td>
                                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${m.value}</td>
                                            <td class="px-3 py-2 text-sm text-gray-700">${totalProduction > 0 ? ((m.value / totalProduction) * 100).toFixed(2) : 0}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Card 2: Revisão -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">${detailed.titleCard2 || 'Novo Conteúdo vs. Revisão'} (Total: ${totalReview})</h4>
                            <table class="min-w-full divide-y divide-gray-100">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Métrica</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reviewMetrics.map(m => `
                                        <tr>
                                            <td class="px-3 py-2 text-sm text-gray-700">${m.label}</td>
                                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${m.value}</td>
                                            <td class="px-3 py-2 text-sm text-gray-700">${totalReview > 0 ? ((m.value / totalReview) * 100).toFixed(2) : 0}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                    </div>
                </div>
            `;
            return html;
        }

        function generateChartDataSummary(chartData) {
            const monthly = chartData.monthlyLimits;
            const weekly = chartData.weeklyActivities;
            const semestre = chartData.semestreActivities;

            let html = `
                <div class="data-card">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Dados dos Gráficos (Pontos)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 text-sm">
                        
                        <!-- Limites Mensais -->
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Limites Mensais (Limite: ${monthly.limit}%)</h4>
                            <ul class="space-y-1">
                                ${monthly.labels.map((label, i) => `
                                    <li class="flex justify-between border-b border-gray-100 py-0.5">
                                        <span class="text-gray-600">${label}:</span>
                                        <span class="font-medium ${monthly.values[i] > monthly.limit ? 'text-red-500' : 'text-green-600'}">${monthly.values[i]}%</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <!-- Atividades da Semana -->
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Atividades da Semana</h4>
                            <ul class="space-y-1">
                                ${weekly && weekly.labels ? weekly.labels.map((label, i) => `
                                    <li class="flex justify-between border-b border-gray-100 py-0.5">
                                        <span class="text-gray-600">${label}:</span>
                                        <span class="font-medium text-gray-800">${weekly.mockValues[i]} unidades</span>
                                    </li>
                                `).join('') : '<li class="text-gray-500">Dados de atividade semanal não disponíveis.</li>'}
                            </ul>
                        </div>
                        
                        <!-- Atividades do Semestre -->
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Atividades 1º Semestre</h4>
                            <ul class="space-y-1">
                                ${semestre && semestre.labels ? semestre.labels.map((label, i) => `
                                    <li class="flex justify-between border-b border-gray-100 py-0.5">
                                        <span class="text-gray-600">Mês ${label}:</span>
                                        <span class="font-medium text-gray-800">${semestre.mockValues[i]} unidades</span>
                                    </li>
                                `).join('') : '<li class="text-gray-500">Dados de semestre não disponíveis.</li>'}
                            </ul>
                        </div>

                    </div>
                </div>
            `;
            return html;
        }

        /**
         * Gera o relatório para uma única página.
         * @param {string} pageId - O ID da página a ser carregada.
         */
        function renderSingleReport(pageId) {
            const pageInfo = PAGE_DEFINITIONS.find(p => p.id === pageId) || { id: pageId, name: 'Página Desconhecida' };
            const data = loadData(pageId);
            
            let html = `
                <h2 class="text-2xl font-bold header-title mb-4">${pageInfo.name} (${pageInfo.id})</h2>
            `;

            if (data) {
                if (data.kpiData.length > 0) {
                    html += generateKpiTable(data.kpiData);
                } else {
                    html += `<div class="data-card text-gray-500">Nenhum Cartão KPI cadastrado.</div>`;
                }

                if (data.chartData) {
                    html += generateDetailedProgress(data.chartData);
                    html += generateChartDataSummary(data.chartData);
                } else {
                    html += `<div class="data-card text-gray-500">Nenhum dado de Gráfico ou Progresso Detalhado encontrado.</div>`;
                }
            } else {
                html = `<div class="data-card bg-red-50 border-red-200 text-red-700">Não foi possível carregar dados para a página ${pageInfo.name} (${pageId}).</div>`;
            }
            
            return html;
        }
        
        /**
         * Gera o relatório para todas as páginas definidas.
         */
        function renderConsolidatedReport() {
            let html = `
                <h2 class="text-2xl font-bold header-title mb-4">Relatório Consolidado de TODAS as Páginas</h2>
            `;
            let isFirst = true;

            PAGE_DEFINITIONS.forEach(page => {
                const data = loadData(page.id);
                
                if (data && (data.kpiData.length > 0 || data.chartData)) {
                    if (!isFirst) {
                        html += `<div class="page-report-separator"></div>`;
                    }
                    
                    html += `
                        <div class="page-data-section">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 bg-gray-200 p-2 rounded-lg">${page.name} (${page.id})</h3>
                            ${generateKpiTable(data.kpiData)}
                            ${generateDetailedProgress(data.chartData)}
                            ${generateChartDataSummary(data.chartData)}
                        </div>
                    `;
                    isFirst = false;
                }
            });

            if (isFirst) {
                 html = `<div class="data-card bg-red-50 border-red-200 text-red-700">Nenhum dado encontrado no LocalStorage para qualquer uma das páginas definidas.</div>`;
            }
            
            return html;
        }


        // =================================================================
        // FUNÇÃO PRINCIPAL
        // =================================================================

        function renderReport() {
            document.getElementById('generation-date').textContent = getCurrentFormattedDateTime();
            const reportContent = document.getElementById('report-content');
            const toggleButton = document.getElementById('toggle-report-mode');
            const reportTypeSpan = document.getElementById('report-type');
            const reportPageIdElement = document.getElementById('report-page-id'); // Novo elemento

            // Determina o modo de visualização (consolidado vs. single)
            const mode = URL_MODE === 'consolidated' ? 'consolidated' : 'single';
            
            reportContent.innerHTML = ''; // Limpa conteúdo

            if (mode === 'consolidated') {
                reportContent.innerHTML = renderConsolidatedReport();
                reportTypeSpan.textContent = 'Modo Consolidado (Todas as páginas)';
                toggleButton.textContent = '→ Mudar para Relatório de Página Única';
                toggleButton.href = `report.html?page=${URL_PAGE_ID || 'index.html'}&mode=single`;
                reportPageIdElement.textContent = 'Dados consolidados de todas as páginas.'; // Limpa/Define o texto no modo consolidado
            } else {
                const pageId = URL_PAGE_ID || 'index.html';
                reportContent.innerHTML = renderSingleReport(pageId);
                reportTypeSpan.textContent = `Dashboard (${pageId})`;
                toggleButton.textContent = '→ Mudar para Relatório Consolidado (Todas as páginas)';
                toggleButton.href = `report.html?mode=consolidated`;
                // Tenta definir o ID da página SOMENTE SE O ELEMENTO EXISTIR
                reportPageIdElement.textContent = `Página de Referência: ${pageId}`;
            }
            
            // Opcional: Adicionar link para Dashboard
            const linkBack = `
                <div class="mt-8 pt-4 border-t border-gray-200 no-print">
                    <a href="index.html?page=${URL_PAGE_ID || 'index.html'}" class="text-indigo-600 hover:text-indigo-800 font-medium">
                        ← Voltar para o Dashboard
                    </a>
                </div>
            `;
            reportContent.insertAdjacentHTML('beforeend', linkBack);
        }

        document.addEventListener('DOMContentLoaded', renderReport);
    </script>
</body>

</html>